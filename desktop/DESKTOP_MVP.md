# Desktop 收银 MVP - 使用说明

## 🎯 已实现功能

### 1. 界面布局

#### 顶部状态栏
- ✅ WebSocket 连接状态（绿点=已连接，红点=未连接）
- ✅ 扫描状态实时显示
- ✅ 输入缓冲区显示（调试用）

#### 中部购物车
- ✅ 商品列表（序号、商品名、单价、数量、小计）
- ✅ 多选框支持批量删除
- ✅ 数量调节按钮（+/-）
- ✅ 空购物车提示

#### 底部操作区
- ✅ 合计总价（大字体显示）
- ✅ 清空按钮
- ✅ 撤销按钮（删除最后一个）
- ✅ 删除选中按钮
- ✅ 提交订单按钮

### 2. 扫码枪支持

#### 得力扫描枪 HID 键盘模式
- ✅ 自动监听键盘输入
- ✅ 累积字符到缓冲区
- ✅ 回车键触发查询
- ✅ 300ms 超时自动重置缓冲区
- ✅ 隐藏输入框保持焦点

**工作原理**:
1. 扫码枪模拟键盘输入
2. 每个字符累积到 `scanBuffer`
3. 输入完成后发送回车键
4. 触发商品查询
5. 自动清空缓冲区

### 3. 商品查询

#### REST API 查询
```typescript
GET /products/by_barcode?code=6901028075831
```

返回商品信息后自动加入购物车。

#### WebSocket 接收
- 监听 `PRODUCT_FOUND` 消息
- 监听 `PRODUCT_NOT_FOUND` 消息
- 等价处理（都会加入购物车或提示）

### 4. 购物车管理

#### 加购规则
- ✅ 同条码商品自动合并
- ✅ 数量 +1
- ✅ 总价实时更新
- ✅ 支持手动调整数量

#### 操作功能
- **清空**: 清空整个购物车
- **撤销**: 删除最后添加的商品
- **删除选中**: 批量删除勾选的商品
- **数量调节**: 点击 +/- 按钮

### 5. 提交订单

```typescript
POST /orders/create
{
  "items": [
    {
      "product_id": 1,
      "barcode": "6901028075831",
      "quantity": 2,
      "price": 3.5
    }
  ],
  "total_amount": 7.0,
  "cashier": "收银员01"
}
```

- ✅ 自动扣减库存
- ✅ 生成订单号
- ✅ 返回订单信息
- ✅ 提交成功后清空购物车

## 🚀 启动步骤

### 1. 配置后端地址

**方式 1: 使用 .env 文件（推荐）**

编辑 `desktop/.env`:
```env
VITE_API_HOST=localhost
VITE_API_PORT=8000

# 局域网使用（修改为实际 IP）
# VITE_API_HOST=192.168.1.100
# VITE_API_PORT=8000
```

**方式 2: 直接修改 config.ts**

编辑 `desktop/src/config.ts`:
```typescript
const API_HOST = "192.168.1.100";  // 修改这里
const API_PORT = "8000";
```

### 2. 安装依赖

```bash
cd desktop
npm install
```

### 3. 启动应用

```bash
npm run tauri:dev
```

首次启动会编译 Rust 代码，需要几分钟。

## 🧪 测试流程

### 测试准备

1. **启动后端服务**
   ```bash
   cd backend
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

2. **启动桌面客户端**
   ```bash
   cd desktop
   npm run tauri:dev
   ```

3. **检查连接状态**
   - 顶部状态栏显示绿点 = 已连接
   - 如果红点，检查后端是否启动

### 测试场景

#### 场景 1: 手动输入条码测试

虽然输入框是隐藏的，但可以直接用键盘输入：

1. 确保窗口焦点在应用上
2. 直接输入条码：`6901028075831`
3. 按回车键
4. 商品应该自动加入购物车

#### 场景 2: 扫码枪测试

1. 连接得力扫描枪（USB）
2. 确保扫描枪处于 HID 键盘模式
3. 扫描商品条码
4. 商品自动加入购物车

#### 场景 3: 购物车操作

1. 添加几个商品
2. 测试数量调节（+/-）
3. 勾选商品，点击"删除选中"
4. 点击"撤销"删除最后一个
5. 点击"清空"清空购物车

#### 场景 4: 提交订单

1. 添加商品到购物车
2. 点击"提交订单"
3. 查看成功提示（显示订单号）
4. 购物车自动清空
5. 后端库存自动扣减

#### 场景 5: WebSocket 测试

1. 打开浏览器控制台（F12）
2. 连接 WebSocket:
   ```javascript
   const ws = new WebSocket('ws://localhost:8000/ws');
   ws.onopen = () => {
     ws.send(JSON.stringify({
       type: 'SCAN_BARCODE',
       code: '6901028075831',
       device_id: 'test-device',
       ts: Date.now()
     }));
   };
   ```
3. 桌面端应该收到消息并加入购物车

## 🔧 配置说明

### 环境变量

创建 `desktop/.env`:
```env
# 后端地址
VITE_API_HOST=localhost
VITE_API_PORT=8000

# 局域网示例
# VITE_API_HOST=192.168.1.100
```

### 代码配置

`desktop/src/config.ts`:
```typescript
export const API_BASE_URL = `http://${API_HOST}:${API_PORT}`;
export const WS_URL = `ws://${API_HOST}:${API_PORT}/ws`;
export const DEVICE_ID = `desktop-${Date.now()}`;
```

## 🐛 故障排除

### 问题 1: WebSocket 连接失败

**症状**: 顶部显示红点

**解决**:
1. 检查后端是否启动
2. 检查 `config.ts` 中的地址
3. 检查防火墙设置
4. 查看浏览器控制台错误

### 问题 2: 扫码无反应

**症状**: 扫码后商品不加入购物车

**解决**:
1. 检查扫描枪是否为 HID 键盘模式
2. 尝试手动输入条码 + 回车
3. 打开开发者工具查看网络请求
4. 检查商品是否存在于数据库

### 问题 3: 提交订单失败

**症状**: 点击提交后报错

**可能原因**:
- 库存不足
- 后端服务未启动
- 网络连接失败

**解决**:
1. 查看错误提示
2. 检查商品库存
3. 查看后端日志

### 问题 4: 隐藏输入框失去焦点

**症状**: 扫码无反应

**解决**:
- 点击窗口任意位置重新获取焦点
- 输入框会自动重新聚焦

## 📁 文件结构

```
desktop/
├── src/
│   ├── App.tsx           # 主应用组件（收银界面）
│   ├── App.css           # 样式文件
│   ├── config.ts         # 配置文件（后端地址）
│   └── main.tsx          # 入口文件
├── .env                  # 环境变量配置
├── .env.example          # 环境变量示例
├── package.json          # npm 依赖
├── vite.config.ts        # Vite 配置
└── DESKTOP_MVP.md        # 本文件
```

## 🎨 界面快捷键

- **Enter**: 提交扫码（条码输入完成后）
- **Tab**: 切换选中（原生功能）
- **点击窗口**: 重新聚焦隐藏输入框

## 📊 性能说明

- WebSocket 自动重连（5秒后）
- 扫码缓冲区 300ms 超时
- 购物车最大显示高度自适应
- 滚动条平滑滚动

## ✨ 特性亮点

1. ✅ **无需点击输入框** - 隐藏输入框自动聚焦
2. ✅ **扫码即用** - 支持 HID 键盘模式扫描枪
3. ✅ **实时反馈** - 扫描状态、缓冲区实时显示
4. ✅ **双通道接收** - REST API + WebSocket
5. ✅ **智能合并** - 同条码自动累加数量
6. ✅ **完整操作** - 清空、撤销、删除、调整数量
7. ✅ **自动扣库存** - 提交订单后自动扣减
8. ✅ **优雅降级** - WebSocket 断开自动重连

## 🎉 完成！

所有功能已实现，可以直接运行！


