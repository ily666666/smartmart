# 微信小程序 MVP - 使用说明

## 🎯 已实现功能

### 1. 首页功能

#### 连接状态显示
- ✅ 绿点 = 已连接
- ✅ 红点 = 未连接

#### 服务器配置
- ✅ 输入电脑端 IP:端口（如 `192.168.1.100:8000`）
- ✅ 保存到本地存储
- ✅ 自动生成设备 ID
- ✅ 设备 ID 可复制

#### 连接控制
- ✅ 手动连接/断开
- ✅ 断线自动重连（5秒后）
- ✅ 连接状态实时更新

### 2. 扫码页功能

#### 扫码功能
- ✅ 调用 `wx.scanCode` 扫描条码
- ✅ 通过 WebSocket 发送 `SCAN_BARCODE` 事件
- ✅ 显示最后扫描的条码
- ✅ 统计扫描次数

#### 消息格式
```json
{
  "type": "SCAN_BARCODE",
  "code": "6901028075831",
  "device_id": "miniapp-1234567890-abc",
  "source": "miniapp",
  "ts": 1234567890123
}
```

### 3. WebSocket 通信

#### 连接管理
- ✅ 使用 `wx.connectSocket` 连接
- ✅ 断线自动重连（5秒延迟）
- ✅ 连接状态同步到全局

#### 消息接收
- ✅ 接收 `PRODUCT_FOUND` 消息并提示（toast）
- ✅ 接收 `PRODUCT_NOT_FOUND` 消息并提示
- ✅ 调试模式显示最后一条消息

## 🚀 开发者工具运行步骤

### 步骤 1: 准备环境

1. **下载微信开发者工具**
   - 官方下载: https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
   - 安装后启动

2. **确保后端服务已启动**
   ```bash
   cd backend
   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

3. **查看电脑局域网 IP**
   ```bash
   # Windows
   ipconfig
   # 找到 IPv4 地址，例如：192.168.1.100
   
   # Mac/Linux
   ifconfig
   ```

### 步骤 2: 导入项目

1. 打开微信开发者工具
2. 点击"导入项目"
3. 选择 `miniapp` 目录
4. AppID 选择"测试号"（或使用自己的 AppID）
5. 项目名称：SmartMart  店小蜜

### 步骤 3: 配置开发环境

#### 3.1 关闭域名校验（重要！）

1. 点击右上角"详情"
2. 选择"本地设置"标签
3. ✅ 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

**说明**: 局域网 IP 无法通过域名校验，开发阶段必须勾选此项。

#### 3.2 配置项目设置

1. 在"详情" → "项目配置"中
2. 确认以下设置：
   - ES6 转 ES5: ✅ 勾选
   - 增强编译: ✅ 勾选
   - 使用 npm 模块: ❌ 不勾选（本项目不需要）

### 步骤 4: 编译运行

1. 点击"编译"按钮
2. 查看控制台是否有错误
3. 如果编译成功，会看到首页界面

### 步骤 5: 配置服务器地址

在小程序首页：

1. 输入服务器地址：`192.168.1.100:8000`（替换为你的电脑 IP）
2. 点击"保存配置"
3. 点击"连接服务器"
4. 等待连接成功（顶部显示绿点）

### 步骤 6: 测试扫码

1. 点击"开始扫码"
2. 允许相机权限
3. 扫描商品条码
4. 查看桌面端是否收到消息

## 🧪 测试流程

### 测试 1: 配置和连接

1. 启动后端服务
2. 打开小程序
3. 输入服务器地址
4. 点击"连接服务器"
5. ✅ 顶部显示绿点 = 成功

### 测试 2: 扫码发送

1. 确保已连接（绿点）
2. 点击"开始扫码"
3. 扫描条码（如 `6901028075831`）
4. ✅ 显示"已发送到桌面端"
5. 查看桌面端购物车是否添加商品

### 测试 3: 断线重连

1. 关闭后端服务
2. 查看小程序状态变为"未连接"（红点）
3. 重新启动后端服务
4. ✅ 5秒后自动重连（变绿点）

### 测试 4: 真机测试

1. 点击"预览"按钮
2. 使用手机微信扫描二维码
3. 确保手机和电脑在同一局域网
4. 重复测试 1-3 的步骤

## 📱 真机运行注意事项

### 1. 网络要求

- ✅ 手机和电脑必须在同一局域网
- ✅ 手机必须连接 WiFi（不能用移动数据）
- ✅ 路由器不能隔离设备（某些路由器有 AP 隔离功能）

### 2. 测试网络连通性

**在手机上测试**:
```
1. 打开手机浏览器
2. 访问 http://192.168.1.100:8000
3. 如果能看到后端 API 页面 = 网络通
```

### 3. 防火墙检查

确保电脑防火墙允许 8000 端口：

```powershell
# Windows
netsh advfirewall firewall add rule name="SmartMart Backend" dir=in action=allow protocol=TCP localport=8000
```

## ⚠️ 局域网 IP 限制与替代方案

### 问题说明

微信小程序对网络请求有严格限制：

1. **开发环境**:
   - ✅ 可以勾选"不校验合法域名"
   - ✅ 可以使用 `ws://192.168.1.100:8000`
   - ✅ 模拟器和真机预览都可用

2. **生产环境（审核/正式版）**:
   - ❌ 必须使用域名（不能用 IP）
   - ❌ 必须使用 HTTPS/WSS
   - ❌ 域名必须在微信后台配置

### 替代方案：使用局域网域名 + HTTPS/WSS

#### 方案 A: 使用 mDNS（局域网域名）

**适用场景**: 局域网内部使用，无需公网域名

1. **设置电脑 mDNS 名称**
   ```bash
   # Windows: 在"系统属性"中设置计算机名
   # 例如: smartmart-server
   
   # Mac: 系统偏好设置 → 共享 → 计算机名称
   ```

2. **使用 `.local` 域名**
   ```javascript
   // 小程序中使用
   const wsUrl = 'ws://smartmart-server.local:8000/ws'
   ```

3. **限制**: 
   - 仅支持 Apple 设备（Mac/iPhone/iPad）
   - Windows/Android 需要安装 Bonjour 服务

#### 方案 B: 配置本地 HTTPS/WSS（推荐生产环境）

**适用场景**: 需要提交审核或正式发布

**步骤 1**: 生成自签名证书

```bash
# 使用 OpenSSL 生成证书
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout server.key \
  -out server.crt \
  -subj "/CN=smartmart.local"
```

**步骤 2**: 配置后端支持 HTTPS

修改 `backend/app/main.py` 添加 SSL 支持：

```python
# 启动命令
uvicorn app.main:app \
  --host 0.0.0.0 \
  --port 8443 \
  --ssl-keyfile=server.key \
  --ssl-certfile=server.crt
```

**步骤 3**: 小程序使用 WSS

```javascript
const wsUrl = 'wss://192.168.1.100:8443/ws'
```

**步骤 4**: 配置微信后台

1. 登录微信公众平台
2. 开发 → 开发管理 → 开发设置
3. 添加服务器域名:
   - request 合法域名: `https://your-domain.com`
   - socket 合法域名: `wss://your-domain.com`

#### 方案 C: 使用内网穿透（开发测试）

**适用场景**: 临时测试，快速验证

1. **使用 ngrok**
   ```bash
   # 安装 ngrok
   # https://ngrok.com/
   
   # 启动穿透
   ngrok http 8000
   ```

2. **获取公网地址**
   ```
   Forwarding: https://abc123.ngrok.io -> localhost:8000
   ```

3. **小程序中使用**
   ```javascript
   const wsUrl = 'wss://abc123.ngrok.io/ws'
   ```

4. **限制**:
   - 每次启动地址会变
   - 免费版有连接限制
   - 网络延迟较高

### 推荐方案总结

| 环境 | 方案 | 配置 |
|------|------|------|
| 开发（局域网） | ws://IP:8000 | ✅ 勾选"不校验域名" |
| 内部测试 | mDNS + ws:// | 设置计算机名 |
| 生产环境 | 域名 + wss:// | 配置 SSL + 微信后台 |
| 临时测试 | ngrok + wss:// | 内网穿透 |

**本 MVP 版本**: 使用方案 1（`ws://IP:8000`），适合局域网开发测试。

## 📁 项目文件说明

| 文件 | 说明 |
|------|------|
| `app.js` | 小程序入口，初始化配置 |
| `app.json` | 全局配置，页面路由 |
| `config.js` | 服务器地址配置 |
| `pages/index/*` | 首页（配置和连接） |
| `pages/scan/*` | 扫码页 |
| `project.config.json` | 项目配置 |

## 🎨 界面说明

### 首页

```
┌─────────────────────────┐
│   SmartMart  店小蜜      │
│   ● 已连接              │
├─────────────────────────┤
│ 服务器配置              │
│ [192.168.1.100:8000]    │
│ 设备ID: miniapp-xxx     │
│ [保存配置]              │
├─────────────────────────┤
│ [连接服务器] [断开连接]  │
├─────────────────────────┤
│ [🔍 开始扫码]           │
└─────────────────────────┘
```

### 扫码页

```
┌─────────────────────────┐
│ ● 已连接  已扫描: 5     │
├─────────────────────────┤
│      ┌───────┐          │
│      │       │          │
│      │  📷   │          │
│      │       │          │
│      └───────┘          │
│   点击下方按钮开始扫码   │
├─────────────────────────┤
│ 最后扫描: 6901028075831  │
├─────────────────────────┤
│    [开始扫码]            │
│    [返回首页]            │
└─────────────────────────┘
```

## 🐛 常见问题

### Q1: 连接失败

**检查清单**:
- [ ] 后端服务是否启动？
- [ ] IP 地址是否正确？
- [ ] 手机和电脑是否在同一网络？
- [ ] 是否勾选"不校验合法域名"？
- [ ] 防火墙是否开放 8000 端口？

### Q2: 扫码无反应

**检查清单**:
- [ ] 是否已连接服务器（顶部绿点）？
- [ ] 相机权限是否允许？
- [ ] 查看控制台是否有错误？

### Q3: 真机预览连不上

**检查清单**:
- [ ] 手机是否连接 WiFi？
- [ ] 手机能否访问 `http://电脑IP:8000`？
- [ ] 路由器是否开启 AP 隔离？

### Q4: 收不到消息

**检查清单**:
- [ ] WebSocket 是否连接成功？
- [ ] 桌面端是否也连接到同一后端？
- [ ] 查看后端日志是否收到消息？

## ✨ 特性亮点

1. ✅ **零配置开箱用** - 输入 IP 即可连接
2. ✅ **自动重连** - 断线 5 秒后自动重连
3. ✅ **本地存储** - 配置保存到本地，无需重复输入
4. ✅ **实时反馈** - 扫码、连接状态实时显示
5. ✅ **调试友好** - 显示最后消息，方便调试
6. ✅ **简洁界面** - MVP 版本专注核心功能

## 🎉 完成！

小程序 MVP 已完成，可以立即使用！

**快速开始**: 
1. 打开微信开发者工具
2. 导入 `miniapp` 目录
3. 勾选"不校验合法域名"
4. 编译运行


