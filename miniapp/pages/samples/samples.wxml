<view class="page-container">
  <!-- åŠ è½½ä¸­ -->
  <view class="loading-state" wx:if="{{loading}}">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <block wx:else>
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-row">
      <view class="stat-card">
        <text class="stat-icon">ğŸ“¦</text>
        <text class="stat-value">{{stats.total}}</text>
        <text class="stat-label">å•†å“æ€»æ•°</text>
      </view>
      <view class="stat-card ready">
        <text class="stat-icon">âœ…</text>
        <text class="stat-value">{{stats.ready}}</text>
        <text class="stat-label">å·²å°±ç»ª</text>
      </view>
      <view class="stat-card partial">
        <text class="stat-icon">âš ï¸</text>
        <text class="stat-value">{{stats.partial}}</text>
        <text class="stat-label">éƒ¨åˆ†å®Œæˆ</text>
      </view>
      <view class="stat-card empty">
        <text class="stat-icon">âŒ</text>
        <text class="stat-value">{{stats.empty}}</text>
        <text class="stat-label">å¾…ä¸Šä¼ </text>
      </view>
    </view>

    <!-- ç´¢å¼•çŠ¶æ€ -->
    <view class="index-section">
      <view class="section-header">
        <text class="section-title">ğŸ” ç´¢å¼•çŠ¶æ€</text>
        <view 
          class="build-btn {{buildProgress.status === 'building' ? 'building' : ''}}"
          bindtap="buildIndex"
        >
          {{buildProgress.status === 'building' ? 'â³ æ„å»ºä¸­...' : 'ğŸ”¨ é‡å»ºç´¢å¼•'}}
        </view>
      </view>

      <view class="index-info" wx:if="{{indexStatus}}">
        <view class="info-item" wx:if="{{indexStatus.exists}}">
          <text class="info-label">çŠ¶æ€</text>
          <text class="info-value success">âœ… å·²æ„å»º</text>
        </view>
        <view class="info-item" wx:if="{{indexStatus.exists}}">
          <text class="info-label">å•†å“æ•°</text>
          <text class="info-value">{{indexStatus.num_skus}}</text>
        </view>
        <view class="info-item" wx:if="{{indexStatus.exists}}">
          <text class="info-label">å‘é‡æ•°</text>
          <text class="info-value">{{indexStatus.num_vectors}}</text>
        </view>
        <view class="info-item warning" wx:if="{{!indexStatus.exists}}">
          <text class="info-value">âš ï¸ ç´¢å¼•æœªæ„å»ºï¼Œè¯·å…ˆä¸Šä¼ å›¾ç‰‡åé‡å»ºç´¢å¼•</text>
        </view>
      </view>

      <!-- æ„å»ºè¿›åº¦ -->
      <view class="build-progress" wx:if="{{buildProgress.status === 'building'}}">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{buildProgress.progress}}%"></view>
        </view>
        <text class="progress-text">{{buildProgress.message}}</text>
      </view>

      <view class="build-result success" wx:if="{{buildProgress.status === 'completed'}}">
        âœ… {{buildProgress.message}}
      </view>

      <view class="build-result error" wx:if="{{buildProgress.status === 'failed'}}">
        âŒ {{buildProgress.message}}
      </view>
    </view>

    <!-- æœç´¢å’Œç­›é€‰ -->
    <view class="filter-section">
      <view class="search-bar">
        <text class="search-icon">ğŸ”</text>
        <input 
          class="search-input"
          placeholder="æœç´¢å•†å“åç§°æˆ–æ¡ç "
          value="{{searchText}}"
          bindinput="onSearchInput"
        />
      </view>
      <view class="status-filters">
        <view 
          class="filter-btn {{statusFilter === 'all' ? 'active' : ''}}"
          data-filter="all"
          bindtap="setStatusFilter"
        >å…¨éƒ¨</view>
        <view 
          class="filter-btn {{statusFilter === 'ready' ? 'active' : ''}}"
          data-filter="ready"
          bindtap="setStatusFilter"
        >âœ… å°±ç»ª</view>
        <view 
          class="filter-btn {{statusFilter === 'partial' ? 'active' : ''}}"
          data-filter="partial"
          bindtap="setStatusFilter"
        >âš ï¸ éƒ¨åˆ†</view>
        <view 
          class="filter-btn {{statusFilter === 'empty' ? 'active' : ''}}"
          data-filter="empty"
          bindtap="setStatusFilter"
        >âŒ å¾…ä¼ </view>
      </view>
    </view>

    <!-- å•†å“åˆ—è¡¨ -->
    <view class="samples-list">
      <view 
        class="sample-card {{item.status}} {{expandedId === item.sku_id ? 'expanded' : ''}}"
        wx:for="{{samples}}"
        wx:key="sku_id"
        wx:if="{{(statusFilter === 'all' || item.status === statusFilter) && (!searchText || item.name.toLowerCase().indexOf(searchText.toLowerCase()) > -1 || item.barcode.indexOf(searchText) > -1)}}"
      >
        <!-- å•†å“ä¿¡æ¯è¡Œ -->
        <view class="sample-item" data-id="{{item.sku_id}}" bindtap="toggleExpand">
          <view class="sample-status">
            <text wx:if="{{item.status === 'ready'}}">âœ…</text>
            <text wx:elif="{{item.status === 'partial'}}">âš ï¸</text>
            <text wx:else>âŒ</text>
          </view>
          <view class="sample-info">
            <text class="sample-name">{{item.name}}</text>
            <text class="sample-barcode">{{item.barcode}}</text>
            <text class="sample-count">{{item.image_count}} å¼ å›¾ç‰‡ {{expandedId === item.sku_id ? 'â–²' : 'â–¼'}}</text>
          </view>
          <view 
            class="upload-btn"
            data-id="{{item.sku_id}}"
            catchtap="quickUpload"
          >
            ğŸ“¤ ä¸Šä¼ 
          </view>
        </view>

        <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
        <view class="images-section" wx:if="{{expandedId === item.sku_id}}">
          <view class="images-grid" wx:if="{{item.images && item.images.length > 0}}">
            <view 
              class="image-item" 
              wx:for="{{item.images}}" 
              wx:for-item="img" 
              wx:for-index="imgIdx"
              wx:key="imgIdx"
            >
              <!-- ä¼˜å…ˆä½¿ç”¨ base64ï¼Œ æ˜¾ç¤ºå›¾ç‰‡ -->
              <image 
                class="sample-image"
                src="{{item.imagesBase64[img] || (apiUrl + '/api/samples/samples/' + item.sku_id + '/images/' + img)}}"
                mode="aspectFill"
                data-sku="{{item.sku_id}}"
                data-images="{{item.images}}"
                data-index="{{imgIdx}}"
                bindtap="previewImage"
              />
              <view 
                class="delete-image-btn"
                data-sku="{{item.sku_id}}"
                data-filename="{{img}}"
                catchtap="deleteImage"
              >Ã—</view>
              <!-- åŠ è½½ä¸­æç¤º -->
              <view class="image-loading" wx:if="{{!item.imagesBase64[img]}}">
                <text>åŠ è½½ä¸­...</text>
              </view>
            </view>
          </view>
          <view class="no-images" wx:else>
            <text>æš‚æ— å›¾ç‰‡ï¼Œç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ·»åŠ </text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{samples.length === 0}}">
      <text class="empty-icon">ğŸ“·</text>
      <text class="empty-text">æš‚æ— å•†å“</text>
    </view>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <view class="help-section">
      <view class="help-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</view>
      <view class="help-list">
        <view class="help-item">
          <text class="help-num">1</text>
          <text class="help-text">ä¸ºæ¯ä¸ªå•†å“ä¸Šä¼  3-10 å¼ ä¸åŒè§’åº¦çš„ç…§ç‰‡</text>
        </view>
        <view class="help-item">
          <text class="help-num">2</text>
          <text class="help-text">å»ºè®®æ‹æ‘„æ­£é¢ã€ä¾§é¢ã€èƒŒé¢ã€45åº¦è§’ç­‰</text>
        </view>
        <view class="help-item">
          <text class="help-num">3</text>
          <text class="help-text">ä¸Šä¼ å®Œæˆåç‚¹å‡»"é‡å»ºç´¢å¼•"</text>
        </view>
      </view>
    </view>
  </block>
</view>
