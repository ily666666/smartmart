<!--pages/vision/vision.wxml-->
<view class="container">
  <!-- çŠ¶æ€æ  -->
  <view class="status-bar">
    <view class="status-item">
      <view class="status-dot {{wsConnected ? 'connected' : 'disconnected'}}"></view>
      <text>{{wsConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}}</text>
    </view>
  </view>

  <!-- ä¸»å¡ç‰‡ï¼ˆæ•´åˆç›¸æœºå’Œæ“ä½œæ ï¼‰ -->
  <view class="main-card" wx:if="{{!candidates.length}}">
    <!-- ç›¸æœºåŒºåŸŸ -->
    <view class="camera-section">
      <!-- å†…åµŒç›¸æœº -->
      <camera 
        wx:if="{{!imagePath && cameraReady}}"
        class="camera"
        device-position="back"
        flash="{{flashMode}}"
        binderror="onCameraError"
      >
        <cover-view class="camera-overlay">
          <cover-view class="camera-tip">å°†å•†å“æ”¾å…¥ç”»é¢ä¸­</cover-view>
        </cover-view>
      </camera>
      
      <!-- æ‹æ‘„çš„å›¾ç‰‡é¢„è§ˆ -->
      <view class="preview-box" wx:if="{{imagePath}}">
        <image src="{{imagePath}}" mode="aspectFill" class="preview-image"></image>
        <view class="preview-status" wx:if="{{compressing || uploading}}">
          <view class="loading-spinner-small"></view>
          <text>{{compressing ? 'å¤„ç†ä¸­...' : 'è¯†åˆ«ä¸­...'}}</text>
        </view>
      </view>
      
      <!-- ç›¸æœºåŠ è½½ä¸­ -->
      <view class="camera-placeholder" wx:if="{{!cameraReady && !imagePath}}">
        <text class="placeholder-icon">ğŸ“·</text>
        <text class="placeholder-text">ç›¸æœºåŠ è½½ä¸­...</text>
      </view>
    </view>
    
    <!-- æ‹ç…§æ“ä½œæ ï¼ˆæ•´åˆåœ¨å¡ç‰‡åº•éƒ¨ï¼‰ -->
    <view class="capture-bar" wx:if="{{!imagePath}}">
      <view class="capture-action" bindtap="toggleFlash">
        <text class="action-icon">{{flashMode === 'on' ? 'ğŸ”¦' : 'ğŸ’¡'}}</text>
        <text class="action-label">é—ªå…‰ç¯</text>
      </view>
      
      <view class="capture-btn" bindtap="capturePhoto">
        <view class="capture-btn-inner"></view>
      </view>
      
      <view class="capture-action" bindtap="chooseFromAlbum">
        <text class="action-icon">ğŸ–¼ï¸</text>
        <text class="action-label">ç›¸å†Œ</text>
      </view>
    </view>
  </view>
  
  <!-- æœ‰å€™é€‰ç»“æœæ—¶æ˜¾ç¤ºå°é¢„è§ˆå›¾ -->
  <view class="result-preview" wx:if="{{candidates.length && imagePath}}">
    <image src="{{imagePath}}" mode="aspectFill" class="result-image"></image>
    <text class="result-label">æ‹æ‘„çš„å›¾ç‰‡</text>
  </view>

  <!-- å€™é€‰å•†å“åˆ—è¡¨ -->
  <view class="candidates-section" wx:if="{{candidates.length}}">
    <view class="section-header">
      <text class="section-title">è¯†åˆ«ç»“æœ</text>
      <text class="section-subtitle">ç‚¹å‡»é€‰æ‹©åŒ¹é…çš„å•†å“</text>
    </view>
    
    <scroll-view class="candidates-list" scroll-y>
      <view 
        class="candidate-item"
        wx:for="{{candidates}}"
        wx:key="sku_id"
        data-index="{{index}}"
        bindtap="confirmProduct"
      >
        <view class="rank rank-{{index + 1}}">{{index + 1}}</view>
        <view class="info">
          <text class="name">{{item.name}}</text>
          <text class="price">Â¥{{item.price}}</text>
        </view>
        <view class="score">
          <text class="score-value">{{item.scorePercent}}%</text>
        </view>
      </view>
    </scroll-view>
    
    <view class="candidates-actions">
      <button class="btn-retake" bindtap="reset">
        ğŸ“· é‡æ–°æ‹ç…§
      </button>
    </view>
  </view>

  <!-- è¯†åˆ«å†å²ï¼ˆæ— å€™é€‰æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="history-section" wx:if="{{!candidates.length && !imagePath && visionHistory.length}}">
    <view class="history-header">
      <text class="history-title">è¯†åˆ«è®°å½•</text>
      <text class="history-clear" bindtap="clearHistory">æ¸…ç©º</text>
    </view>
    <scroll-view class="history-list" scroll-y>
      <view 
        class="history-item success"
        wx:for="{{visionHistory}}"
        wx:key="id"
      >
        <view class="history-icon">âœ…</view>
        <view class="history-info">
          <text class="history-name">{{item.name}}</text>
          <text class="history-code">{{item.time}}</text>
        </view>
        <view class="history-right">
          <text class="history-price">Â¥{{item.price}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åŠ è½½é®ç½© -->
  <view class="loading-overlay" wx:if="{{compressing || uploading}}">
    <view class="loading-box">
      <view class="loading-spinner"></view>
      <text class="loading-text">
        {{compressing ? 'å¤„ç†å›¾ç‰‡...' : 'è¯†åˆ«å•†å“...'}}
      </text>
    </view>
  </view>

  <!-- åº•éƒ¨åˆ‡æ¢æ  -->
  <view class="mode-switch-bar">
    <view class="mode-switch-inner">
      <view class="mode-btn" bindtap="switchToScan">
        <text class="mode-icon">ğŸ”</text>
        <text class="mode-text">æ‰«ç å½•å…¥</text>
      </view>
      <view class="mode-btn active">
        <text class="mode-icon">ğŸ‘ï¸</text>
        <text class="mode-text">AIè¯†åˆ«</text>
      </view>
    </view>
  </view>
</view>
